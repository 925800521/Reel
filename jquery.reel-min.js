/*
 Copyright (c) 2009-2010 Petr Vostrel (http://petr.vostrel.cz/)
 Dual licensed under the MIT (MIT-LICENSE.txt)
 and GPL (GPL-LICENSE.txt) licenses.

 http://jquery.vostrel.cz/reel
 Version: "Dancer" (will be 1.1 on release)
 Updated: 2010-08-06

 Requires jQuery 1.4.x
*/
(function(k,qb,Qa,p){function Ra(i){return"<"+i+"/>"}function X(i){return"."+i}function Y(i){return"url("+i+")"}function L(i){return+i.toFixed(4)}function M(i,a,t){return N(i,va(a,t))}function Sa(i){function a(){k.fn[this]||(k.fn[this]=function(){return this})}k.each(i,a)}function Z(i,a){return A(i)*(a?-1:1)}function O(i){return i.originalEvent.touches[0]}function Ta(){var i=[];k.each(wa,function(a){i.push(a+"\u203a"+this)});wa={};i.length&&console.log("[reel]",i.join(" "))}var Ua=k.reel={footage:6,
frame:1,frames:36,hint:"",horizontal:true,hotspot:p,indicator:0,klass:"",loops:true,reversed:p,spacing:0,stitched:p,suffix:"-reel",tooltip:"",brake:0.5,cw:false,delay:-1,draggable:true,graph:p,image:p,images:[],monitor:p,path:"",preloader:4,rebound:0.5,revolution:p,row:1,rows:0,speed:0,step:p,steps:p,tempo:25,timeout:2,throwable:true,wheelable:true};k.fn.reel=function(i){var a=k.extend({},Ua,i);i=function(g){var d=[];g.filter(Va).each(function(){var c=k(this),n=a.images.length&&a.images||a.image||
c.attr(xa),w=P(c.css(ya)),u=P(c.css(za));!n||n==Aa||!w||!u||d.push(c)});g.filter(Ba+X(E)).each(function(){d.push(k(this))});return k(d)}(this);var t=[];a.reversed&&(a.cw=true);a.tooltip&&(a.hint=a.tooltip);$=$||function g(){F.trigger(aa);return setTimeout(g,1E3/a.tempo)}();i.each(function(){var g=k(this),d=function(e,b){g.data(e,b);g.trigger("store");return b},c=function(e){g.trigger("recall");return g.data(e)},n=function(e){delete this;return e},w={setup:function(e){if(g.hasClass(E))return n.call(e);
var b=g.attr(xa),f=g.attr(Wa),j=g.attr("style"),h=a.images,l=a.stitched,o=a.loops,m={x:P(g.css(ya)),y:P(g.css(za))},s={display:"block",width:m.x,height:m.y};s=g.attr({src:a.images?Xa:b}).bind(w).addClass(E).css(s);t.push(s[0]);d(ba,h.length&&h.length||a.image||b.replace(/^(.*)\.(jpg|jpeg|png|gif)$/,"$1"+a.suffix+".$2"));d(x,a.frame);d(Ca,a.spacing);d(G,m);d(q,0);d(ca,a.steps||a.frames);d(Q,a.revolution||l/2||m.x);d(Da,Ea(d(R,h.length||a.frames)/a.footage));d(da,1/(c(R)-(o&&!l?0:1)));d(Ya,1/N(c(R),
c(ca)));d(Fa,l-(o?0:m.x));d(Ga,m.x-a.indicator);d(H,"#"+f+a.suffix);d(y,d(ea,a.speed)<0);d(B,0);d(v,(a.row-1)/(a.rows-1));d(S,Z(1,!a.cw&&!l));d(Ha,{src:b,style:j||Aa});$&&F.bind(aa,w.tick);n.call(e);g.trigger("start")},teardown:function(e){k(c(H)).remove();g.removeClass(E).unbind(r).unbind(w).attr(g.data(Ha)).enableTextSelect().removeData();T();F.unbind(fa).unbind(U).unbind(aa,w.tick);n.call(e)},start:function(e){var b=c(G),f=c(R),j=N(f,c(ca));j=d(q,1/j*((a.step||a.frame)-1));d(x,j*f+1);f=c(ba);j=
a.images;f=!j.length?[f]:[].concat(j);g.attr("id");var h=g[0];h.frames=f.length;h.preloads=h.preloads||[];h.preloaded=h.preloaded||0;j=f.length!=h.preloads.length;var l=c(H).substr(1);l=k(I,{className:Za,id:l,css:{position:"relative",width:b.x}}).insertAfter(g);var o=k(I,{className:$a,css:{position:V,left:0,top:-b.y,width:b.x,height:b.y}}).appendTo(l);o=d(ga,k(a.hotspot||o));ab?o.css({WebkitUserSelect:"none"}).bind(bb,function(m){g.trigger("down",[O(m).clientX,O(m).clientY,true]);return false}).bind(cb,
function(m){g.trigger("drag",[O(m).clientX,O(m).clientY,true]);return false}).bind(db,function(){g.trigger("up",[true]);return false}).bind(eb,function(){g.trigger("up",[true]);return false}):o.css({cursor:"url("+Ia+"), "+ha}).bind(fb,function(){g.trigger("enter")}).bind(gb,function(){g.trigger("leave")}).bind(U,function(m){g.trigger("over",[m.pageX,m.pageY])}).bind(hb,function(m,s){g.trigger("wheel",[s]);return false}).bind(ib,function(){g.trigger("animate")}).bind(jb,function(m){g.trigger("down",
[m.clientX,m.clientY]);return false}).disableTextSelect();a.hint&&o.attr(kb,a.hint);a.monitor&&l.append(ia=k(I,{className:lb,css:{position:V,left:0,top:-b.y}}))||(ia=k());a.indicator&&l.append(Ja("x"));a.rows&&a.indicator&&l.append(Ja("y"));if(j)for(l.append(ja=k(I,{className:mb,css:{position:V,left:0,top:-a.preloader,height:a.preloader,backgroundColor:Ka}}));f.length;){j=new Image;l=a.path+f.shift();k(j).load(function(){h.preloaded++;ja.css({width:1/h.frames*h.preloaded*b.x});h.frames==h.preloaded&&
ja.remove()});j.src=l;h.preloads.push(j)}a.delay>0&&z();n.call(e);g.trigger(a.rows&&!a.stitched?"rowChange":"frameChange")},animate:function(){},tick:function(e){var b=c(B);if(J){var f=L(b-nb*J);b=!(b*f<=0||b<A(f))&&d(B,b>A(c(ea))?f:(J=u=0))}ia.text(c(a.monitor));b&&J++;u&&u++;La(0);Ta();if(u&&!b)return n.call(e);if(c(ka))return n.call(e,z());f=c(S)*Z(1,c(y));b=(c(la)?b:A(c(ea))+b)/a.tempo;d(q,c(q)-b*f);n.call(e);g.trigger("fractionChange")},play:function(e){var b=d(ma,true);d(la,!b);Ma();n.call(e)},
pause:function(e){d(ma,false);z();n.call(e)},stop:function(e){var b=d(la,true);d(ma,!b);n.call(e)},down:function(e,b,f,j){if(!a.draggable)return n.call(e);d(ka,true);d(B,0);na(b,f,c(q),c(Q),c(v));oa=p;z();T();!j&&F.bind(U,function(h){g.trigger("drag",[h.clientX,h.clientY]);n.call(h)}).bind(fa,function(h){g.trigger("up");n.call(h)})&&c(ga).css({cursor:Y(ob)+", "+ha});n.call(e)},up:function(e,b){if(!a.draggable)return n.call(e);d(ka,false);var f=d(B,!a.throwable?0:A(C[0]+C[1]+C[2])/60);J=f?1:0;f?Ma():
z();T();!b&&F.unbind(fa).unbind(U)&&c(ga).css({cursor:Y(Ia)+", "+ha});n.call(e)},drag:function(e,b,f){if(!a.draggable)return n.call(e);var j=c(Q),h=c(Na),l=La(b-oa||0),o=d(q,Oa(b-h.x,c(pa),j,c(qa),c(ra),c(S)));l&&d(y,l<0);if(a.rows){l=c(G).y;var m=c(Pa),s=-m*l;d(v,L(k.reel.math.envelope(f-h.y,m,l,s,s+l,-1)))}!(o%1)&&!a.loops&&na(b,f,o,j,c(v));z();oa=b;n.call(e);g.trigger("fractionChange")},wheel:function(e,b){if(!a.wheelable)return n.call(e);var f=Ea(pb(A(b))/2);f=Z(f,b>0);b=0.2*c(Q);na(p,p,c(q),
b,c(v));d(q,Oa(f,c(pa),b,c(qa),c(ra),c(S)));f&&d(y,f<0);d(B,0);z();n.call(e);g.trigger("fractionChange");return false},fractionChange:function(e,b){b=!b?c(q):d(q,b);b=a.loops?b-W(b):M(0,1,b);b=d(q,L(b));d(x,1+W(b/c(da)));if(!a.loops&&a.rebound){!u&&!(b%1)?sa++:(sa=0);sa>=a.rebound*1E3/a.tempo&&d(y,!c(y))}n.call(e);g.trigger(a.rows&&!a.stitched?"rowChange":"frameChange")},rowChange:function(e,b){b=d(v,M(0,1,b||c(v)));d(x,c(x)+(!a.rows?0:K(b*(a.rows-1))*a.frames));n.call(e);g.trigger("frameChange")},
frameChange:function(e,b){var f=!b?c(q):d(q,L(c(da)*(b-1)));b=d(x,K(b?b:c(x)));var j=a.images,h=a.footage,l=a.horizontal;if(a.stitched)l=[-K(f*c(Fa))+D,0+D];else{var o=b%h-1;o=o<0?h-1:o;var m=W((b-0.1)/h);m+=a.rows?0:c(y)?0:c(Da);h=c(G);var s=c(Ca);m=m*((l?h.y:h.x)+s);o=o*((l?h.x:h.y)+s);l=j.length?[0,0]:l?[-o+D,-m+D]:[-m+D,-o+D]}b=j[b-1]||c(ba);j=c(Ga);f=M(0,j,K(k.reel.math.interpolate(f,-1,j+2)));f=!a.cw||a.stitched?f:j-f;j={background:Y(a.path+b)+ta+l.join(ta)};a.images.length?g.attr({src:a.path+
b}):g.css(j);k(X(ua+".x"),c(H)).css({left:f});if(!a.rows)return n.call(e);f=c(G).y-a.indicator;b=M(0,f,K(k.reel.math.interpolate(c(v),-1,f+2)));k(X(ua+".y"),c(H)).css({top:b-f-a.indicator});n.call(e)}},u,J=0,Ma=function(){return u=0},z=function(){return u=-a.timeout*a.tempo},ia,ja,Ja=function(e){return k(I,{className:[ua,e].join(ta),css:{width:a.indicator,height:a.indicator,top:e=="y"?p:-a.indicator,left:e=="x"?p:0,position:V,backgroundColor:Ka}})},sa=0,oa=0,La=function(e){return C.push(e)&&C.shift()&&
e},T=function(){return C=[0,0,0]},C=T(),nb=a.brake/a.tempo,Oa=a.graph||k.reel.math[a.loops?"hatch":"envelope"],na=function(e,b,f,j,h){d(pa,f);d(Pa,h);d(qa,a.loops?0:-f*j);d(ra,a.loops?j:j-f*j);return e&&d(Na,{x:e,y:b})||p};w.setup()});return k(t)};k.reel.math={envelope:function(i,a,t,g,d,c){return a+N(g,va(d,-i*c))/t},hatch:function(i,a,t,g,d,c){i=(i<g?d:0)+i%d;i=a+-i*c/t;return i-W(i)},interpolate:function(i,a,t){return a+i*(t-a)}};Sa("mousewheel disableTextSelect enableTextSelect".split(/ /));var F=
k(Qa),ab=/iphone|ipod|ipad|android/i.test(navigator.userAgent),ha="ew-resize",$,E="jquery-reel",Za=E+"-overlay",ua="indicator",mb="preloader",lb="monitor",$a="interface",Xa="data:image/gif;base64,R0lGODlhCAAIAIAAAAAAAAAAACH5BAEAAAAALAAAAAAIAAgAAAIHhI+py+1dAAA7",Ia="data:image/gif;base64,R0lGODlhEAAQAJECAAAAAP///////wAAACH5BAEAAAIALAAAAAAQABAAQAI3lC8AeBDvgosQxQtne7yvLWGStVBelXBKqDJpNzLKq3xWBlU2nUs4C/O8cCvU0EfZGUwt19FYAAA7",ob="data:image/gif;base64,R0lGODlhEAAQAJECAAAAAP///////wAAACH5BAEAAAIALAAAAAAQABAAQAIslI95EB3MHECxNjBVdE/5b2zcRV1QBabqhwltq41St4hj5konmVioZ6OtEgUAOw==",
K=Math.round,W=Math.floor,Ea=Math.ceil,va=Math.min,N=Math.max,A=Math.abs,pb=Math.sqrt,P=parseInt,Ha="backup",y="backwards",da="bit",ka="clicked",Na="clicked_location",pa="clicked_on",Pa="clicked_row",S="cwish",G="dimensions",q="fraction",x="frame",R="frames",ra="hi",ga="hotspot",ba="image",Ga="indicator_travel",qa="lo",ma="playing",Q="revolution",v="row",Da="rows",Ca="spacing",ea="speed",H="stage",ca="steps",Fa="stitched_travel",la="stopped",B="velocity",Ya="wheel_step",r=".reel",ib="dblclick"+r,
jb="mousedown"+r,fb="mouseenter"+r,gb="mouseleave"+r,U="mousemove"+r,fa="mouseup"+r,hb="mousewheel"+r,aa="tick"+r,eb="touchcancel"+r,db="touchend"+r,bb="touchstart"+r,cb="touchmove"+r,Aa="",ta=" ",V="absolute",Ba="div",I=Ra(Ba),za="height",Ka="#000",Wa="id",Va="img",D="px",xa="src",kb="title",ya="width",wa={}})(jQuery,window,document);
