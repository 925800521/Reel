/*
 Copyright (c) 2009-2010 Petr Vostrel (http://petr.vostrel.cz/)
 Dual licensed under the MIT (MIT-LICENSE.txt)
 and GPL (GPL-LICENSE.txt) licenses.

 http://jquery.vostrel.cz/reel
 Version: 1.1 RC
 Updated: 2010-10-31

 Requires jQuery 1.4.x
*/
(function(k,xb,Wa,n){function Xa(j){return"<"+j+"/>"}function aa(j){return"."+j}function ba(j){return"url("+j+")"}function B(j){return+j.toFixed(4)}function O(j,a,u){return P(j,Aa(a,u))}function Ya(j){function a(){k.fn[this]||(k.fn[this]=function(){return this})}k.each(j,a)}function ca(j,a){return C(j)*(a?-1:1)}function Q(j){return j.originalEvent.touches[0]}var Za=k.reel={footage:6,frame:1,frames:36,hint:"",horizontal:true,hotspot:n,indicator:0,klass:"",loops:true,reversed:n,spacing:0,stitched:n,
suffix:"-reel",tooltip:"",area:n,brake:0.5,clickfree:false,couple:n,cw:false,delay:-1,directional:false,draggable:true,graph:n,image:n,images:[],monitor:n,maximum:100,minimum:0,path:"",preloader:4,rebound:0.5,revolution:n,row:1,rows:0,speed:0,step:n,steps:n,tempo:25,timeout:2,throwable:true,value:n,wheelable:true};k.fn.reel=function(j){var a=k.extend({},Za,j);j=function(g){var d=[];g.filter($a).each(function(){var c=k(this),l=a.images.length&&a.images||a.image||c.attr(Ba),y=R(c.css(Ca)),v=R(c.css(Da));
!l||l==Ea||!y||!v||d.push(c)});g.filter(Fa+aa(w)).each(function(){d.push(k(this))});return k(d)}(this);var u=[];a.reversed&&(a.cw=true);a.tooltip&&(a.hint=a.tooltip);a.hotspot&&(a.area=a.hotspot);da=da||function g(){D.trigger(ea);return setTimeout(g,1E3/a.tempo)}();j.each(function(){var g=k(this),d=function(f,b){g.data(f,b);g.trigger("store");return b},c=function(f){g.trigger("recall");return g.data(f)},l=function(f){ab||delete this;return f},y={setup:function(f){if(g.hasClass(w))return l.call(f);
var b=g.attr(Ba),e=g.attr(bb),i=g.attr("style"),h=a.images,m=a.stitched,p=a.loops,o={x:R(g.css(Ca)),y:R(g.css(Da))},q=a.images?cb:b,r=d(Ga,!a.rows&&h.length||a.frames),fa=m?1:Ha(r/a.footage),db={display:"block",width:o.x,height:o.y};e="#"+e+a.suffix;var Ia=g.attr("className"),ga={position:"relative",width:o.x,height:o.y};ga=k(K,{id:e.substr(1),className:Ia+S+eb,css:ga});q=g.wrap(ga).attr({src:q,className:w,style:db}).bind(y);u.push(q[0]);d(ha,h.length&&h.length||a.image||b.replace(/^(.*)\.(jpg|jpeg|png|gif)$/,
"$1"+a.suffix+".$2"));d(Ja,Ia);d(E,a.frame);d(Ka,a.spacing);d(F,o);d(s,0);d(ia,a.steps||a.frames);d(T,a.revolution||m/2||o.x);d(ja,fa);d(U,1/(r-(p&&!m?0:1)));d(fb,1/P(r,c(ia)));d(La,m);d(Ma,m-(p?0:o.x));d(Na,o.x-a.indicator);d(V,e);d(z,d(ka,a.speed)<0);d(G,0);d(x,(a.row-1)/(a.rows-1));d(H,a.value||0);d(W,ca(1,!a.cw&&!m));d(Oa,{src:b,style:i||Ea});da&&D.bind(ea,y.tick);l.call(f);g.trigger("start")},teardown:function(f){g.unbind(t).unbind(y);var b=g.clone().attr(g.data(Oa)).removeClass(w).addClass(c(Ja));
k(c(V)).before(b).detach();X();D.unbind(Y).unbind(Z).unbind(ea,y.tick);l.call(f)},start:function(f){var b=c(F),e=c(Ga),i=P(e,c(ia));i=d(s,1/i*((a.step||a.frame)-1));d(E,i*e+1);e=c(ha);i=a.images;e=!i.length?[e]:[].concat(i);g.attr("id");var h=g[0];h.frames=e.length;h.preloads=h.preloads||[];h.preloaded=h.preloaded||0;var m=e.length!=h.preloads.length,p=g.parent(),o=k(K,{className:gb,css:{position:$,left:0,top:0,width:b.x,height:b.y,background:la,opacity:0}}).appendTo(p);o=d(ma,k(a.area||o));var q=
g.add(a.couple);hb?o.css({WebkitUserSelect:"none",WebkitBackgroundSize:i.length?"auto":c(La)||b.x*a.footage+"px "+b.y*c(ja)*(a.rows||1)*(a.directional?2:1)+"px"}).bind(ib,function(r){q.trigger("down",[Q(r).clientX,Q(r).clientY,true]);return false}).bind(jb,function(r){q.trigger("slide",[Q(r).clientX,Q(r).clientY,true]);return false}).bind(kb,function(){q.trigger("up",[true]);return false}).bind(lb,function(){q.trigger("up",[true]);return false}):o.css({cursor:"url("+Pa+"), "+na}).bind(Z,function(r){q.trigger("over",
[r.pageX,r.pageY])}).bind(mb,function(r,fa){q.trigger("wheel",[fa]);return false}).bind(nb,function(){q.trigger("play")}).bind(a.clickfree?ob:pb,function(r){q.trigger("down",[r.clientX,r.clientY]);return false}).bind(a.clickfree?qb:Y,function(){q.trigger("up");return false}).disableTextSelect();a.hint&&o.attr(rb,a.hint);a.monitor&&p.append(oa=k(K,{className:sb,css:{position:$,left:0,top:0}}))||(oa=k());a.indicator&&p.append(Qa("x"));a.rows&&a.indicator&&p.append(Qa("y"));if(m)for(p.append(pa=k(K,
{className:tb,css:{position:$,left:0,top:b.y-a.preloader,height:a.preloader,backgroundColor:la}}));e.length;){i=new Image;m=a.path+e.shift();k(i).load(function(){h.preloaded++;pa.css({width:1/h.frames*h.preloaded*b.x});h.frames==h.preloaded&&pa.remove()});i.src=m;h.preloads.push(i)}a.delay>0&&A();a.value!=n&&g.trigger("valueChange",c(H));l.call(f);g.trigger(a.rows&&!a.stitched?"rowChange":"frameChange")},tick:function(f){var b=c(G);if(L){var e=B(b-ub*L);b=!(b*e<=0||b<C(e))&&d(G,b>C(c(ka))?e:(L=v=
0))}oa.text(c(a.monitor));b&&L++;v&&v++;Ra(0);g[0].value!=c(H)&&g.trigger("valueChange",g[0].value);if(v&&!b)return l.call(f);if(c(qa))return l.call(f,A());e=c(W)*ca(1,c(z));b=(c(ra)?b:C(c(ka))+b)/a.tempo;d(s,c(s)-b*e);l.call(f);g.trigger("fractionChange")},play:function(f){var b=d(sa,true);d(ra,!b);Sa();l.call(f)},pause:function(f){d(sa,false);A();l.call(f)},stop:function(f){var b=d(ra,true);d(sa,!b);l.call(f)},down:function(f,b,e,i){if(!a.draggable)return l.call(f);d(qa,true);d(G,0);ta(b,e,c(s),
c(T),c(x));ua=n;A();X();!i&&D.bind(Z,function(h){g.trigger("slide",[h.clientX,h.clientY]);l.call(h)}).css({cursor:ba(vb)+", "+na})&&!a.clickfree&&D.bind(Y,function(h){g.trigger("up");l.call(h)})&&c(ma);l.call(f)},up:function(f,b){if(!a.draggable)return l.call(f);d(qa,false);var e=d(G,!a.throwable?0:C(I[0]+I[1]+I[2])/60);L=e?1:0;e?Sa():A();X();!b&&D.unbind(Y).unbind(Z)&&c(ma).css({cursor:ba(Pa)+", "+na});l.call(f)},slide:function(f,b,e){if(!a.draggable)return l.call(f);var i=c(T),h=c(Ta),m=Ra(b-ua||
0),p=d(s,Ua(b-h.x,c(va),i,c(wa),c(xa),c(W)));m&&d(z,m<0);if(a.rows){m=c(F).y;var o=c(Va),q=-o*m;d(x,B(k.reel.math.envelope(e-h.y,o,m,q,q+m,-1)))}!(p%1)&&!a.loops&&ta(b,e,p,i,c(x));A();ua=b;l.call(f);g.trigger("fractionChange")},wheel:function(f,b){if(!a.wheelable)return l.call(f);var e=Ha(wb(C(b))/2);e=ca(e,b>0);b=0.2*c(T);ta(n,n,c(s),b,c(x));d(s,Ua(e,c(va),b,c(wa),c(xa),c(W)));e&&d(z,e<0);d(G,0);A();l.call(f);g.trigger("fractionChange");return false},fractionChange:function(f,b,e){b=!b?c(s):d(s,
b);b=a.loops?b-M(b):O(0,1,b);b=d(s,B(b));d(E,1+M(b/c(U)));d(H,B(k.reel.math.interpolate(b,a.minimum,a.maximum)));if(!a.loops&&a.rebound){!v&&!(b%1)?ya++:(ya=0);ya>=a.rebound*1E3/a.tempo&&d(z,!c(z))}l.call(f);e||g.trigger("valueChange");g.trigger(a.rows&&!a.stitched?"rowChange":"frameChange")},rowChange:function(f,b){var e=M(c(s)/c(U))+1;b=d(x,O(0,1,B(b!=n?(b-1)/(a.rows-1):c(x))));d(E,e+(!a.rows?0:N(b*(a.rows-1))*a.frames));l.call(f);g.trigger("frameChange")},frameChange:function(f,b){var e=!b?c(s):
d(s,B(c(U)*(b-1)));b=d(E,N(b?b:c(E)));var i=a.images,h=a.footage,m=a.horizontal;if(a.stitched)m=[-N(e*c(Ma))+J,0+J];else{var p=b%h-1;p=p<0?h-1:p;var o=M((b-0.1)/h);o+=a.rows?0:c(z)?0:c(ja);h=c(F);var q=c(Ka);o=o*((m?h.y:h.x)+q);p=p*((m?h.x:h.y)+q);m=i.length?[0,0]:m?[-p+J,-o+J]:[-o+J,-p+J]}b=i[b-1]||c(ha);i=c(Na);e=O(0,i,N(k.reel.math.interpolate(e,-1,i+2)));e=!a.cw||a.stitched?e:i-e;i={background:ba(a.path+b)+S+m.join(S)};a.images.length?g.attr({src:a.path+b}):g.css(i);k(aa(za+".x"),c(V)).css({left:e});
if(!a.rows)return l.call(f);e=c(F).y-a.indicator;e=O(0,e,N(k.reel.math.interpolate(c(x),-1,e+2)));k(aa(za+".y"),c(V)).css({top:e});l.call(f)},valueChange:function(f,b){f=b!==n&&d(s,b/(a.maximum-a.minimum));g[0].value=b===n?c(H):d(H,b);f===false||g.trigger("fractionChange",[n,true])}},v,L=0,Sa=function(){return v=0},A=function(){return v=-a.timeout*a.tempo},oa,pa,Qa=function(f){return k(K,{className:[za,f].join(S),css:{width:a.indicator,height:a.indicator,top:f=="y"?n:c(F).y-a.indicator,left:f=="x"?
n:0,position:$,backgroundColor:la}})},ya=0,ua=0,Ra=function(f){return I.push(f)&&I.shift()&&f},X=function(){return I=[0,0,0]},I=X(),ub=a.brake/a.tempo,Ua=a.graph||k.reel.math[a.loops?"hatch":"envelope"],ta=function(f,b,e,i,h){d(va,e);d(Va,h);d(wa,a.loops?0:-e*i);d(xa,a.loops?i:i-e*i);return f&&d(Ta,{x:f,y:b})||n};y.setup()});return k(u)};k.reel.math={envelope:function(j,a,u,g,d,c){return a+P(g,Aa(d,-j*c))/u},hatch:function(j,a,u,g,d,c){j=(j<g?d:0)+j%d;j=a+-j*c/u;return j-M(j)},interpolate:function(j,
a,u){return a+j*(u-a)}};Ya("mousewheel disableTextSelect enableTextSelect".split(/ /));var D=k(Wa),hb=/iphone|ipod|ipad|android/i.test(navigator.userAgent),ab=k.browser.msie,na="ew-resize",da,w="jquery-reel",eb=w+"-overlay",za=w+"-indicator",tb=w+"-preloader",sb=w+"-monitor",gb=w+"-interface",cb="data:image/gif;base64,R0lGODlhCAAIAIAAAAAAAAAAACH5BAEAAAAALAAAAAAIAAgAAAIHhI+py+1dAAA7",Pa="data:image/gif;base64,R0lGODlhEAAQAJECAAAAAP///////wAAACH5BAEAAAIALAAAAAAQABAAQAI3lC8AeBDvgosQxQtne7yvLWGStVBelXBKqDJpNzLKq3xWBlU2nUs4C/O8cCvU0EfZGUwt19FYAAA7",
vb="data:image/gif;base64,R0lGODlhEAAQAJECAAAAAP///////wAAACH5BAEAAAIALAAAAAAQABAAQAIslI95EB3MHECxNjBVdE/5b2zcRV1QBabqhwltq41St4hj5konmVioZ6OtEgUAOw==",N=Math.round,M=Math.floor,Ha=Math.ceil,Aa=Math.min,P=Math.max,C=Math.abs,wb=Math.sqrt,R=parseInt,ma="area",Oa="backup",z="backwards",U="bit",Ja="classes",qa="clicked",Ta="clicked_location",va="clicked_on",Va="clicked_row",W="cwish",F="dimensions",s="fraction",E="frame",Ga="frames",xa="hi",ha="image",Na="indicator_travel",wa="lo",sa="playing",T="revolution",
x="row",ja="rows",Ka="spacing",ka="speed",V="stage",ia="steps",La="stitched",Ma="stitched_travel",ra="stopped",H="value",G="velocity",fb="wheel_step",t=".reel",nb="dblclick"+t,pb="mousedown"+t,ob="mouseenter"+t,qb="mouseleave"+t,Z="mousemove"+t,Y="mouseup"+t,mb="mousewheel"+t,ea="tick"+t,lb="touchcancel"+t,kb="touchend"+t,ib="touchstart"+t,jb="touchmove"+t,Ea="",S=" ",$="absolute",Fa="div",K=Xa(Fa),Da="height",la="#000",bb="id",$a="img",J="px",Ba="src",rb="title",Ca="width"})(jQuery,window,document);
