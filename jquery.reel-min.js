/* Copyright (c) 2009-2010 Petr Vostrel (http://www.pisi.cz/)
 * Dual licensed under the MIT (MIT-LICENSE.txt)
 * and GPL (GPL-LICENSE.txt) licenses.
 *
 * http://www.vostrel.cz/jquery/reel/
 * Version: "Dancer" (will be 1.1 on release)
 * Updated: 2010-05-21
 *
 * Requires jQuery 1.4.x or higher
 */
(function(m){function A(o,p){return+p.toFixed(o)}function E(o,p,a){return v(o,F(p,a))}function O(o,p){return o*p>0?p:-p}function P(o){m.each(o,function(){m.fn[this]||(m.fn[this]=function(){return this})})}var Q={footage:6,frame:1,frames:36,hint:"",horizontal:true,hotspot:undefined,indicator:0,klass:"",loops:true,reversed:false,saves:false,sensitivity:20,spacing:0,stitched:undefined,suffix:"-reel",tooltip:"",delay:1,frequency:0.25,friction:0.8,inertial:true,maximum:100,minimum:0,monitor:undefined,
revolution:undefined,step:undefined,steps:undefined,tempo:25,timeout:2};m.fn.reel=function(o){var p=function(c){var d=[];c.filter("img").each(function(){var g=m(this),q=g.attr("src"),s=x(g.css("width")),t=x(g.css("height"));!q||q==""||!s||!t||d.push(g)});c.filter("div."+B).each(function(){d.push(m(this))});return m(d)}(this),a=m.extend({},Q,o),G=[];y=y||function(){return setInterval(function(){w.trigger(C)},1E3/a.tempo)}();p.each(function(){var c=m(this),d=function(e,b){c.data(e,b);c.trigger("store");
return b},g=function(e){c.trigger("recall");return c.data(e)},q={setup:function(){if(!c.hasClass(B)){var e=c.attr("src"),b=c.attr("id"),f=c.attr("class"),i=c.attr("style");e=e.replace(/^(.*)\.(jpg|jpeg|png|gif)$/,"$1"+a.suffix+".$2");var h={x:x(c.css("width")),y:x(c.css("height"))},j=m("<div>").attr("class",f).addClass(B).addClass(a.klass),k=H||!a.saves?{display:"none"}:{opacity:0};G.push((c=c.attr("id","").wrap(j).css(k).parent().attr("id",b).bind(q).css({display:"block",width:h.x+"px",height:h.y+
"px",backgroundImage:"url("+e+")"}))[0]);d("frames",a.frames);d("spacing",a.spacing);d("offset",c.offset());d("dimensions",h);d("fraction",0);d("steps",a.steps||a.frames);d("resolution",v(a.steps,a.frames));d("reversed",a.frequency<0);d("backup",{id:b,"class":f||"",style:i||""});y&&w.bind(C,q.tick);c.trigger("start")}},teardown:function(){c=c.unbind(q).find(".indicator, .monitor").remove().end().find("img").attr(c.data("backup")).unwrap().bind("setup",function(){c.unbind("setup");q.setup()});y&&w.unbind(C,
q.tick)},start:function(){c.css({position:"relative"});var e=a.hotspot?a.hotspot:c,b=g("dimensions"),f=g("frames"),i=v(f,g("steps"));i=d("fraction",1/i*((a.step||a.frame)-1));d("frame",i*f+1);e.css({cursor:"ew-resize"}).mouseenter(function(){c.trigger("enter")}).mouseleave(function(){c.trigger("leave")}).mousemove(function(h){c.trigger("over",[h.clientX,h.clientY])}).mousewheel(function(h,j){c.trigger("wheel",[j]);return false}).dblclick(function(){c.trigger("animate")}).mousedown(function(h){c.trigger("down",
[h.clientX,h.clientY])}).disableTextSelect().each(function(){function h(n,u){m.each(u,function(R){n.addEventListener(R,this,false)})}function j(n){n.cancelable&&n.preventDefault();return false}function k(n){var u=n.touches[0];d("clicked",true);d("clicked_location",u.clientX);d("last_frame",d("clicked_on_frame",g("frame")));return j(n)}function l(n){var u=n.touches[0];c.trigger("drag",[u.clientX,u.clientY]);return j(n)}function I(n){d("clicked",false);return j(n)}H&&h(this,{touchstart:k,touchmove:l,
touchend:I,touchcancel:I,click:j,gesturestart:j,gesturechange:j,gestureend:j})});(a.hint||a.tooltip)&&e.attr("title",a.hint||a.tooltip);a.monitor&&c.append(m("<div/>",{className:"monitor",css:{position:"absolute",left:0,top:0}}));a.indicator&&c.append(m("<div/>").addClass("indicator").css({width:a.indicator+"px",height:a.indicator+"px",top:b.y-a.indicator+"px",position:"absolute",backgroundColor:"#000"}));c.trigger("frameChange")},animate:function(){},tick:function(){var e=a.frequency,b=a.friction/
a.tempo,f=g("velocity"),i=f<0;f-=f*b;f=J=f==J?0:f;f=(i?F:v)(0,A(3,f))||0;f=d("velocity",f);step=(e+f)/a.tempo;m(".monitor",c).text(g(a.monitor));K(0);s&&s++;if(!(s&&!f)){if(g("clicked"))return t();d("fraction",g("fraction")+step);c.trigger("fractionChange")}},down:function(e,b){t();d("clicked",true);d("clicked_location",b);d("velocity",0);d("last_fraction",d("clicked_on",g("fraction")));w.mousemove(function(f){c.trigger("drag",[f.clientX,f.clientY])}).mouseup(function(){c.trigger("up")})},up:function(){d("clicked",
false);var e=r[1]+r[2]!=0,b=(r[0]+r[1]+r[2])/r.length/20;d("velocity",a.inertial&&e?a.stitched?-b:b:0);L();s=0;w.unbind("mousemove mouseup")},drag:function(e,b){t();e=g("clicked_location");var f=g("clicked_on"),i=a.stitched,h=g("dimensions");d("fraction",f+(a.reversed?-1:1)*(i?-1:1)/(a.revolution||i/2||h.x)*(b-e));K(b-M);M=b;c.trigger("fractionChange")},wheel:function(e,b){t();d("velocity",0);e=g("fraction");var f=1/v(g("frames"),g("steps")),i=D(S(T(b))/2);i=b<0?-i:i;d("fraction",e+i*f);c.trigger("fractionChange");
return false},fractionChange:function(e,b){b=!b?g("fraction"):d("fraction",b);e=g("last_fraction");a.frequency=O(b-e,a.frequency);b=a.loops?b-(b<0?D:N)(b):E(0,1,b);b=!a.loops?b:b>=0?b:1+b;b=d("last_fraction",d("fraction",A(6,b)));d("frame",b*(g("frames")-1)+1);c.trigger("frameChange")},frameChange:function(e,b){var f=g("frames");e=!b?g("fraction"):d("fraction",A(6,(b-1)/(f-1)));b=!b?g("frame"):d("frame",b);b=d("frame",z(b));var i=g("dimensions");g("steps");var h=g("spacing"),j=g("reversed");if(a.stitched){h=
a.loops?a.stitched:a.stitched-i.x;k=z(e*h);l=0;j=-k+"px "+l+"px"}else{k=N(b/a.footage);l=b-k*a.footage-1;k=l==-1?k+l:k;l=l==-1?a.footage+l:l;b=a.horizontal?i.y:i.x;var k=-k*(h+b),l=-l*(h+(a.horizontal?i.x:i.y));f=D(f/a.footage);h=f*b+(f-1)*h;k=j&&a.horizontal?k-h:k;l=j&&!a.horizontal?l-h:l;j=a.horizontal?l+"px "+k+"px":k+"px "+l+"px"}h=i.x-a.indicator;e=E(0,h,z(e*(h+2))-1);c.css({backgroundPosition:j}).find(".indicator").css({left:e+"px"})}},s=a.delay>0?-z(a.delay*a.tempo):0,t=function(){return s=
-a.timeout*a.tempo},M=0,J=0,K=function(e){r.push(e)&&r.shift()},L=function(){return r=[0,0,0]},r=L();c.ready(q.setup)});return m(G)};P("mousewheel disableTextSelect".split(/ /));var B="jquery-reel",C="tick.reel",w=m(document),H=/iphone|ipod|ipad|android/i.test(navigator.userAgent),y,x=parseInt,z=Math.round,N=Math.floor,D=Math.ceil,F=Math.min,v=Math.max,S=Math.sqrt,T=Math.abs})(jQuery);
