/* Copyright (c) 2009-2010 Petr Vostrel (http://www.pisi.cz/)
 * Dual licensed under the MIT (MIT-LICENSE.txt)
 * and GPL (GPL-LICENSE.txt) licenses.
 *
 * http://www.vostrel.cz/jquery/reel/
 * Version: "Dancer" (will be 1.1 on release)
 * Updated: 2010-05-21
 *
 * Requires jQuery 1.4.x or higher
 */
(function(m){function D(o,p){return+p.toFixed(o)}function I(o,p,a){return v(o,J(p,a))}function Q(o,p){return o*p>0?p:-p}function R(o){m.each(o,function(){m.fn[this]||(m.fn[this]=function(){return this})})}var S={footage:6,frame:1,frames:36,hint:"",horizontal:true,hotspot:undefined,indicator:0,klass:"",loops:true,reversed:false,saves:false,sensitivity:20,spacing:0,stitched:undefined,suffix:"-reel",tooltip:"",delay:-1,frequency:0.25,friction:0.8,inertial:true,maximum:100,minimum:0,monitor:undefined,
rebound:0.5,revolution:undefined,step:undefined,steps:undefined,tempo:25,timeout:2};m.fn.reel=function(o){var p=function(c){var d=[];c.filter("img").each(function(){var g=m(this),q=g.attr("src"),r=y(g.css("width")),t=y(g.css("height"));!q||q==""||!r||!t||d.push(g)});c.filter("div."+E).each(function(){d.push(m(this))});return m(d)}(this),a=m.extend({},S,o),K=[];z=z||function(){return setInterval(function(){w.trigger(F)},1E3/a.tempo)}();p.each(function(){var c=m(this),d=function(e,b){c.data(e,b);c.trigger("store");
return b},g=function(e){c.trigger("recall");return c.data(e)},q={setup:function(){if(!c.hasClass(E)){var e=c.attr("src"),b=c.attr("id"),f=c.attr("class"),i=c.attr("style");e=e.replace(/^(.*)\.(jpg|jpeg|png|gif)$/,"$1"+a.suffix+".$2");var h={x:y(c.css("width")),y:y(c.css("height"))},j=m("<div>").attr("class",f).addClass(E).addClass(a.klass),k=L||!a.saves?{display:"none"}:{opacity:0};K.push((c=c.attr("id","").wrap(j).css(k).parent().attr("id",b).bind(q).css({display:"block",width:h.x+"px",height:h.y+
"px",backgroundImage:"url("+e+")"}))[0]);d("frames",a.frames);d("spacing",a.spacing);d("offset",c.offset());d("dimensions",h);d("fraction",0);d("steps",a.steps||a.frames);d("resolution",v(a.steps,a.frames));d("reversed",a.frequency<0);d("backup",{id:b,"class":f||"",style:i||""});z&&w.bind(F,q.tick);c.trigger("start")}},teardown:function(){c=c.unbind(q).find(".indicator, .monitor").remove().end().find("img").attr(c.data("backup")).unwrap().bind("setup",function(){c.unbind("setup");q.setup()});z&&w.unbind(F,
q.tick)},start:function(){c.css({position:"relative"});var e=a.hotspot?a.hotspot:c,b=g("dimensions"),f=g("frames"),i=v(f,g("steps"));i=d("fraction",1/i*((a.step||a.frame)-1));d("frame",i*f+1);e.css({cursor:"ew-resize"}).mouseenter(function(){c.trigger("enter")}).mouseleave(function(){c.trigger("leave")}).mousemove(function(h){c.trigger("over",[h.clientX,h.clientY])}).mousewheel(function(h,j){c.trigger("wheel",[j]);return false}).dblclick(function(){c.trigger("animate")}).mousedown(function(h){c.trigger("down",
[h.clientX,h.clientY])}).disableTextSelect().each(function(){function h(n,u){m.each(u,function(x){n.addEventListener(x,this,false)})}function j(n){n.cancelable&&n.preventDefault();return false}function k(n){var u=n.touches[0];d("clicked",true);d("clicked_location",u.clientX);d("last_frame",d("clicked_on_frame",g("frame")));return j(n)}function l(n){t();var u=n.touches[0],x=u.clientX;c.trigger("drag",[x,u.clientY]);G(x-A);A=x;return j(n)}function M(n){d("clicked",false);return j(n)}L&&h(this,{touchstart:k,
touchmove:l,touchend:M,touchcancel:M,click:j,gesturestart:j,gesturechange:j,gestureend:j})});(a.hint||a.tooltip)&&e.attr("title",a.hint||a.tooltip);a.monitor&&c.append(m("<div/>",{className:"monitor",css:{position:"absolute",left:0,top:0}}));a.indicator&&c.append(m("<div/>").addClass("indicator").css({width:a.indicator+"px",height:a.indicator+"px",top:b.y-a.indicator+"px",position:"absolute",backgroundColor:"#000"}));c.trigger("frameChange")},animate:function(){},tick:function(){var e=a.frequency,
b=a.friction/a.tempo,f=g("velocity"),i=f<0;f-=f*b;f=N=f==N?0:f;f=(i?J:v)(0,D(3,f))||0;f=d("velocity",f);step=(e+f)/a.tempo;m(".monitor",c).text(g(a.monitor));G(0);r&&r++;if(!(r&&!f)){if(g("clicked"))return t();d("fraction",g("fraction")+step);c.trigger("fractionChange")}},down:function(e,b){t();d("clicked",true);d("clicked_location",b);d("velocity",0);d("last_fraction",d("clicked_on",g("fraction")));w.mousemove(function(f){c.trigger("drag",[f.clientX,f.clientY])}).mouseup(function(){c.trigger("up")})},
up:function(){d("clicked",false);var e=s[1]+s[2]!=0,b=(s[0]+s[1]+s[2])/s.length/20;d("velocity",a.inertial&&e?a.stitched?-b:b:0);O();r=0;w.unbind("mousemove mouseup")},drag:function(e,b){t();e=g("clicked_location");var f=g("clicked_on"),i=a.stitched,h=g("dimensions");d("fraction",f+(a.reversed?-1:1)*(i?-1:1)/(a.revolution||i/2||h.x)*(b-e));G(b-A);A=b;c.trigger("fractionChange")},wheel:function(e,b){t();d("velocity",0);e=g("fraction");var f=1/v(g("frames"),g("steps")),i=H(T(U(b))/2);i=b<0?-i:i;d("fraction",
e+i*f);c.trigger("fractionChange");return false},fractionChange:function(e,b){b=!b?g("fraction"):d("fraction",b);e=g("last_fraction");e=a.frequency=Q(b-e,a.frequency);b=a.loops?b-(b<0?H:P)(b):I(0,1,b);a.frequency=!a.loops&&a.rebound&&B==a.rebound*1E3/a.tempo?-e:e;b=!a.loops?b:b>=0?b:1+b;b=d("last_fraction",d("fraction",D(6,b)));d("frame",b*(g("frames")-1)+1);!r&&(B=b==0||b==1?B+1:0);console.log(r,B);c.trigger("frameChange")},frameChange:function(e,b){var f=g("frames");e=!b?g("fraction"):d("fraction",
D(6,(b-1)/(f-1)));b=!b?g("frame"):d("frame",b);b=d("frame",C(b));var i=g("dimensions");g("steps");var h=g("spacing"),j=g("reversed");if(a.stitched){h=a.loops?a.stitched:a.stitched-i.x;k=C(e*h);l=0;j=-k+"px "+l+"px"}else{k=P(b/a.footage);l=b-k*a.footage-1;k=l==-1?k+l:k;l=l==-1?a.footage+l:l;b=a.horizontal?i.y:i.x;var k=-k*(h+b),l=-l*(h+(a.horizontal?i.x:i.y));f=H(f/a.footage);h=f*b+(f-1)*h;k=j&&a.horizontal?k-h:k;l=j&&!a.horizontal?l-h:l;j=a.horizontal?l+"px "+k+"px":k+"px "+l+"px"}h=i.x-a.indicator;
e=I(0,h,C(e*(h+2))-1);c.css({backgroundPosition:j}).find(".indicator").css({left:e+"px"})}},r=a.delay>0?-C(a.delay*a.tempo):0,t=function(){return r=-a.timeout*a.tempo},B=0,A=0,N=0,G=function(e){s.push(e)&&s.shift()},O=function(){return s=[0,0,0]},s=O();c.ready(q.setup)});return m(K)};R("mousewheel disableTextSelect".split(/ /));var E="jquery-reel",F="tick.reel",w=m(document),L=/iphone|ipod|ipad|android/i.test(navigator.userAgent),z,y=parseInt,C=Math.round,P=Math.floor,H=Math.ceil,J=Math.min,v=Math.max,
T=Math.sqrt,U=Math.abs})(jQuery);
